<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WuTong Mountain - Consciousness Evolution Game</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Georgia', serif;
            color: #e8e8e8;
            overflow-x: hidden;
            background: #1a2332;
        }

        /* Reality-aware backgrounds */
        .game-container {
            min-height: 100vh;
            position: relative;
            transition: all 1s ease;
        }

        .game-container.wutong {
            background: linear-gradient(135deg, #2d5a4a, #1e3d34, #0f2821);
        }

        .game-container.wokemound {
            background: linear-gradient(135deg, #4c2b24, #341f1a, #1a0e09);
        }

        /* Floating consciousness particles */
        .consciousness-particles {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            animation: float 15s ease-in-out infinite;
        }

        .particle.wutong {
            background: radial-gradient(circle, rgba(77, 183, 121, 0.6), transparent);
        }

        .particle.wokemound {
            background: radial-gradient(circle, rgba(255, 165, 0, 0.6), transparent);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
            25% { transform: translateY(-40px) rotate(90deg); opacity: 0.7; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 0.9; }
            75% { transform: translateY(-35px) rotate(270deg); opacity: 0.5; }
        }

        /* Main game layout */
        .game-layout {
            display: grid;
            grid-template-columns: 300px 1fr 320px;
            gap: 20px;
            padding: 20px;
            min-height: 100vh;
            position: relative;
            z-index: 10;
        }

        @media (max-width: 1200px) {
            .game-layout {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 15px;
            }
        }

        /* Left Panel - Player Stats & Status */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Reality Status */
        .reality-status {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 20px;
            border: 2px solid;
            backdrop-filter: blur(15px);
            text-align: center;
            transition: all 0.5s ease;
        }

        .reality-status.wutong {
            border-color: #4db779;
            box-shadow: 0 0 20px rgba(77, 183, 121, 0.3);
        }

        .reality-status.wokemound {
            border-color: #ff6b47;
            box-shadow: 0 0 20px rgba(255, 107, 71, 0.3);
        }

        .reality-title {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .reality-title.wutong {
            color: #4db779;
            text-shadow: 0 0 10px rgba(77, 183, 121, 0.5);
        }

        .reality-title.wokemound {
            color: #ff6b47;
            text-shadow: 0 0 10px rgba(255, 107, 71, 0.5);
        }

        .reality-description {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 15px;
        }

        .reality-switch-btn {
            padding: 12px 20px;
            border: 2px solid;
            border-radius: 10px;
            background: transparent;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .reality-switch-btn.wutong {
            border-color: #ff6b47;
            color: #ff6b47;
        }

        .reality-switch-btn.wutong:hover {
            background: rgba(255, 107, 71, 0.2);
            transform: scale(1.05);
        }

        .reality-switch-btn.wokemound {
            border-color: #4db779;
            color: #4db779;
        }

        .reality-switch-btn.wokemound:hover {
            background: rgba(77, 183, 121, 0.2);
            transform: scale(1.05);
        }

        /* Player Stats */
        .stats-panel {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid #444;
            backdrop-filter: blur(15px);
        }

        .stats-title {
            font-size: 1.2em;
            color: #f0c674;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-name {
            font-size: 0.9em;
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-weight: bold;
            color: #f0c674;
            font-size: 1.1em;
        }

        .stat-bar {
            width: 100%;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
            position: relative;
        }

        .stat-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f39c12, #2ecc71, #3498db);
            transition: width 0.8s ease;
            border-radius: 4px;
        }

        /* Consciousness Level */
        .consciousness-display {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid #444;
            backdrop-filter: blur(15px);
            text-align: center;
        }

        .consciousness-ring {
            width: 80px;
            height: 80px;
            border: 4px solid #333;
            border-radius: 50%;
            margin: 0 auto 15px;
            position: relative;
            background: conic-gradient(from 0deg, #e74c3c 0%, #f39c12 25%, #2ecc71 50%, #3498db 75%, #9b59b6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: gentle-rotate 20s linear infinite;
        }

        @keyframes gentle-rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .consciousness-inner {
            width: 70px;
            height: 70px;
            background: #1a2332;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #f0c674;
            font-size: 1.4em;
        }

        .consciousness-level-name {
            font-size: 1em;
            color: #f0c674;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .spiral-points {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* Center Panel - Story & Choices */
        .story-panel {
            background: rgba(0, 0, 0, 0.85);
            border-radius: 25px;
            padding: 30px;
            border: 1px solid #444;
            backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            min-height: 80vh;
        }

        .story-header {
            border-bottom: 2px solid #444;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        .location-name {
            font-size: 1.6em;
            color: #f0c674;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .location-context {
            font-size: 0.9em;
            opacity: 0.8;
            font-style: italic;
        }

        .story-content {
            flex: 1;
            line-height: 1.7;
            font-size: 1.1em;
            margin-bottom: 30px;
            text-align: justify;
        }

        .choices-section {
            margin-top: auto;
        }

        .choices-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .choices-title {
            font-size: 1.2em;
            color: #f0c674;
        }

        .choice-count {
            font-size: 0.8em;
            opacity: 0.7;
        }

        .choice-option {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #555;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .choice-option::before {
            content: '';
            position: absolute;
            top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(240, 198, 116, 0.1), transparent);
            transition: left 0.6s ease;
        }

        .choice-option:hover::before {
            left: 100%;
        }

        .choice-option:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #f0c674;
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(240, 198, 116, 0.2);
        }

        .choice-text {
            font-size: 1em;
            margin-bottom: 8px;
            position: relative;
            z-index: 2;
        }

        .choice-meta {
            font-size: 0.8em;
            opacity: 0.7;
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 2;
        }

        .community-choice {
            border-left: 4px solid #3498db;
            background: rgba(52, 152, 219, 0.05);
        }

        /* Right Panel - Memory & Progress */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Recent Memories */
        .memory-panel {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid #444;
            backdrop-filter: blur(15px);
        }

        .memory-title {
            font-size: 1.1em;
            color: #f0c674;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
        }

        .memory-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .memory-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: #3498db;
        }

        .memory-date {
            font-size: 0.7em;
            opacity: 0.6;
            margin-bottom: 3px;
        }

        .memory-text {
            font-size: 0.8em;
            line-height: 1.3;
        }

        /* Action Buttons */
        .action-panel {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid #444;
            backdrop-filter: blur(15px);
        }

        .action-button {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid;
            border-radius: 12px;
            background: transparent;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .action-button.primary {
            border-color: #3498db;
            color: #3498db;
        }

        .action-button.primary:hover {
            background: rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .action-button.secondary {
            border-color: #f39c12;
            color: #f39c12;
        }

        .action-button.secondary:hover {
            background: rgba(243, 156, 18, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }

        /* Loading states */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 25px;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-text {
            margin-top: 15px;
            font-size: 1.1em;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .left-panel, .right-panel {
                order: 2;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .story-panel {
                order: 1;
                min-height: 60vh;
            }
        }

        @media (max-width: 768px) {
            .left-panel, .right-panel {
                grid-template-columns: 1fr;
            }
            
            .game-layout {
                padding: 10px;
                gap: 10px;
            }
            
            .story-panel {
                padding: 20px;
                min-height: 50vh;
            }
        }
    </style>
</head>
<body>
    <!-- Floating consciousness particles -->
    <div class="consciousness-particles" id="particles"></div>

    <!-- Main game container -->
    <div class="game-container wutong" id="gameContainer">
        <div class="game-layout">
            <!-- Left Panel - Player Status -->
            <div class="left-panel">
                <!-- Reality Status -->
                <div class="reality-status wutong" id="realityStatus">
                    <h2 class="reality-title wutong" id="realityTitle">WuTong Mountain</h2>
                    <p class="reality-description" id="realityDescription">
                        Utopian 2100 - Where consciousness evolves through service to others
                    </p>
                    <button class="reality-switch-btn wutong" id="realitySwitchBtn" onclick="switchReality()">
                        Enter WokeMound
                    </button>
                </div>

                <!-- Player Stats -->
                <div class="stats-panel">
                    <h3 class="stats-title">Consciousness Development</h3>
                    
                    <div class="stat-item">
                        <span class="stat-name">Insight</span>
                        <span class="stat-value" id="insightValue">35</span>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-fill" id="insightBar" style="width: 35%"></div>
                    </div>
                    
                    <div class="stat-item">
                        <span class="stat-name">Presence</span>
                        <span class="stat-value" id="presenceValue">35</span>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-fill" id="presenceBar" style="width: 35%"></div>
                    </div>
                    
                    <div class="stat-item">
                        <span class="stat-name">Resolve</span>
                        <span class="stat-value" id="resolveValue">35</span>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-fill" id="resolveBar" style="width: 35%"></div>
                    </div>
                    
                    <div class="stat-item">
                        <span class="stat-name">Vigor</span>
                        <span class="stat-value" id="vigorValue">35</span>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-fill" id="vigorBar" style="width: 35%"></div>
                    </div>
                    
                    <div class="stat-item">
                        <span class="stat-name">Harmony</span>
                        <span class="stat-value" id="harmonyValue">35</span>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-fill" id="harmonyBar" style="width: 35%"></div>
                    </div>
                </div>

                <!-- Consciousness Level -->
                <div class="consciousness-display">
                    <div class="consciousness-ring">
                        <div class="consciousness-inner" id="consciousnessLevel">0</div>
                    </div>
                    <div class="consciousness-level-name" id="consciousnessName">Unconscious</div>
                    <div class="spiral-points" id="spiralPoints">0 Spiral Points</div>
                </div>
            </div>

            <!-- Center Panel - Story Content -->
            <div class="story-panel">
                <div class="loading-overlay" id="storyLoading">
                    <div class="loading-content">
                        <div class="loading"></div>
                        <div class="loading-text">Generating consciousness evolution content...</div>
                    </div>
                </div>

                <div class="story-header">
                    <h2 class="location-name" id="locationName">Arrival Point</h2>
                    <p class="location-context" id="locationContext">
                        Beginning your consciousness evolution journey
                    </p>
                </div>

                <div class="story-content" id="storyContent">
                    Welcome to your consciousness evolution journey. The path ahead offers opportunities for growth through service to others and healing of collective trauma. Your choices will shape not only your own development but contribute to the healing of all realities.

                    In this dual reality system, you can experience both the utopian potential of WuTong Mountain in 2100, where consciousness workers help heal nightmare realities, and the horror of WokeMound, where you directly experience the forced change trauma that needs healing.

                    Each choice you make will develop your consciousness stats: INSIGHT (understanding), PRESENCE (awareness), RESOLVE (determination), VIGOR (energy), and HARMONY (balance). Through service to others, you earn Spiral Points that advance your consciousness level.
                </div>

                <div class="choices-section">
                    <div class="choices-header">
                        <h3 class="choices-title">How do you wish to begin?</h3>
                        <span class="choice-count" id="choiceCount">4 choices available</span>
                    </div>

                    <div class="choice-option" onclick="selectChoice(1)" data-mechanics="PRESENCE + HARMONY">
                        <div class="choice-text">Explore the meditation gardens and observe the community</div>
                        <div class="choice-meta">
                            <span>üßò Observation</span>
                            <span>PRESENCE + HARMONY</span>
                        </div>
                    </div>

                    <div class="choice-option community-choice" onclick="selectChoice(2)" data-mechanics="INSIGHT + PRESENCE">
                        <div class="choice-text">Seek out someone who needs help and offer assistance</div>
                        <div class="choice-meta">
                            <span>ü§ù Service Action</span>
                            <span>INSIGHT + PRESENCE</span>
                        </div>
                    </div>

                    <div class="choice-option" onclick="selectChoice(3)" data-mechanics="INSIGHT">
                        <div class="choice-text">Study the consciousness development systems and archives</div>
                        <div class="choice-meta">
                            <span>üìö Learning</span>
                            <span>INSIGHT</span>
                        </div>
                    </div>

                    <div class="choice-option" onclick="selectChoice(4)" data-mechanics="RESOLVE">
                        <div class="choice-text">Request to visit WokeMound to understand the trauma being healed</div>
                        <div class="choice-meta">
                            <span>‚ö° Challenge</span>
                            <span>RESOLVE</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Memory & Actions -->
            <div class="right-panel">
                <!-- Recent Memories -->
                <div class="memory-panel">
                    <h3 class="memory-title">Memory Fragments</h3>
                    
                    <div class="memory-item" onclick="viewMemory(1)">
                        <div class="memory-date">Journey Start</div>
                        <div class="memory-text">Arrived at WuTong Mountain consciousness evolution system</div>
                    </div>
                    
                    <div class="memory-item" onclick="viewMemory(2)">
                        <div class="memory-date">System Briefing</div>
                        <div class="memory-text">Learned about dual reality healing through service to others</div>
                    </div>
                    
                    <div class="memory-item" onclick="viewMemory(3)">
                        <div class="memory-date">Initial Assessment</div>
                        <div class="memory-text">Consciousness stats baseline established for growth tracking</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-panel">
                    <button class="action-button primary" onclick="generateNewStory()">
                        Generate New Story
                    </button>
                    <button class="action-button secondary" onclick="accessMemoryArchive()">
                        Memory Archive
                    </button>
                    <button class="action-button secondary" onclick="dreamSharing()">
                        Dream Sharing
                    </button>
                    <button class="action-button secondary" onclick="returnToLanding()">
                        Return to Landing
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Backend URL
        const BACKEND_URL = window.location.origin;

        // Game state
        let gameState = {
            currentReality: 'wutong',
            passphrase: 'demo-player',
            player: null,
            isLoading: false
        };

        // Initialize from URL parameters or use demo
        function initializeGame() {
            const params = new URLSearchParams(window.location.search);
            gameState.passphrase = params.get('passphrase') || 'demo-player';
            gameState.currentReality = params.get('reality') || 'wutong';
            
            console.log('Initializing game with:', gameState);
            
            // Load player data if available
            loadPlayerData();
            
            // Create particles
            createParticles();
            
            // Set initial reality state
            updateRealityDisplay();
        }

        // Create reality-aware particles
        function createParticles() {
            const container = document.getElementById('particles');
            container.innerHTML = ''; // Clear existing
            
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = `particle ${gameState.currentReality}`;
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.width = (Math.random() * 8 + 4) + 'px';
                particle.style.height = particle.style.width;
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                container.appendChild(particle);
            }
        }

        // Switch between realities
        async function switchReality() {
            if (gameState.isLoading) return;
            
            const newReality = gameState.currentReality === 'wutong' ? 'wokemound' : 'wutong';
            
            try {
                gameState.isLoading = true;
                showStoryLoading('Transferring consciousness...');
                
                // API call to switch reality
                const response = await fetch(`${BACKEND_URL}/api/reality/switch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        passphrase: gameState.passphrase,
                        target_reality: newReality
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Reality switch response:', data);
                }

                // Update game state
                gameState.currentReality = newReality;
                updateRealityDisplay();
                
                // Generate new story for this reality
                await generateNewStory();
                
            } catch (error) {
                console.error('Reality switch error:', error);
                // Continue with local state change
                gameState.currentReality = newReality;
                updateRealityDisplay();
                generateBasicStory();
            } finally {
                gameState.isLoading = false;
                hideStoryLoading();
            }
        }

        // Update UI based on current reality
        function updateRealityDisplay() {
            const container = document.getElementById('gameContainer');
            const status = document.getElementById('realityStatus');
            const title = document.getElementById('realityTitle');
            const description = document.getElementById('realityDescription');
            const switchBtn = document.getElementById('realitySwitchBtn');

            // Update container background
            container.className = `game-container ${gameState.currentReality}`;

            if (gameState.currentReality === 'wutong') {
                status.className = 'reality-status wutong';
                title.className = 'reality-title wutong';
                title.textContent = 'WuTong Mountain';
                description.textContent = 'Utopian 2100 - Where consciousness evolves through service to others';
                switchBtn.className = 'reality-switch-btn wutong';
                switchBtn.textContent = 'Enter WokeMound';
            } else {
                status.className = 'reality-status wokemound';
                title.className = 'reality-title wokemound';
                title.textContent = 'WokeMound';
                description.textContent = 'Horror Mystery - "A Fresh Start for Everyone" - Face the forced change nightmare';
                switchBtn.className = 'reality-switch-btn wokemound';
                switchBtn.textContent = 'Return to WuTong Mountain';
            }

            // Update particles
            createParticles();
        }

        // Load player data from API
        async function loadPlayerData() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/player/${gameState.passphrase}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        gameState.player = data.player;
                        updatePlayerDisplay(data.player);
                        console.log('Player loaded successfully:', data.player);
                    }
                } else {
                    console.log('Player not found, using demo data');
                    loadDemoPlayer();
                }
            } catch (error) {
                console.error('Error loading player:', error);
                loadDemoPlayer();
            }
        }

        // Load demo player for testing
        function loadDemoPlayer() {
            gameState.player = {
                passphrase: 'demo-player',
                consciousness_level: 0,
                spiral_points: 0,
                stats: {
                    insight: 35,
                    presence: 35,
                    resolve: 35,
                    vigor: 35,
                    harmony: 35
                }
            };
            updatePlayerDisplay(gameState.player);
        }

        // Update player display
        function updatePlayerDisplay(player) {
            // Update stats
            const stats = ['insight', 'presence', 'resolve', 'vigor', 'harmony'];
            stats.forEach(stat => {
                const value = player.stats[stat] || 0;
                document.getElementById(`${stat}Value`).textContent = value;
                document.getElementById(`${stat}Bar`).style.width = value + '%';
            });

            // Update consciousness
            document.getElementById('consciousnessLevel').textContent = player.consciousness_level;
            document.getElementById('spiralPoints').textContent = `${player.spiral_points} Spiral Points`;
            
            const levelNames = {
                0: "Unconscious", 1: "Awakening", 2: "Recognition", 3: "Courage",
                4: "Integration", 5: "Mastery", 6: "Responsibility", 7: "Mystery"
            };
            document.getElementById('consciousnessName').textContent = levelNames[player.consciousness_level] || "Unknown";
        }

        // Generate new story content
        async function generateNewStory() {
            if (gameState.isLoading) return;
            
            try {
                gameState.isLoading = true;
                showStoryLoading('Generating consciousness evolution content...');
                
                const response = await fetch(`${BACKEND_URL}/api/story/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        passphrase: gameState.passphrase,
                        reality: gameState.currentReality,
                        previous_choice: null
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.story) {
                        updateStoryDisplay(data);
                    } else {
                        generateBasicStory();
                    }
                } else {
                    generateBasicStory();
                }
                
            } catch (error) {
                console.error('Story generation error:', error);
                generateBasicStory();
            } finally {
                gameState.isLoading = false;
                hideStoryLoading();
            }
        }

        // Generate basic story content (fallback)
        function generateBasicStory() {
            const stories = {
                wutong: {
                    location: "The Dream Circle Pavilion",
                    context: "A crystalline platform overlooking the ocean, humming with dream frequencies",
                    content: "You stand at the Dream Circle Pavilion where consciousness workers gather to help heal nightmare realities. The crystalline resonance stones pulse with accumulated dream frequencies from countless healing sessions. A newcomer sits at the edge, struggling with memories of forced technological enhancement from their previous reality. The community's approach to healing trauma through service creates opportunities for both their recovery and your consciousness growth.",
                    choices: [
                        {
                            text: "Approach with compassion and offer to share your transformation story",
                            mechanics: "PRESENCE + HARMONY",
                            type: "service"
                        },
                        {
                            text: "Invite them to a community healing circle you could facilitate",
                            mechanics: "HARMONY + RESOLVE",
                            type: "leadership"
                        },
                        {
                            text: "Study their trauma pattern to understand how best to help",
                            mechanics: "INSIGHT + PRESENCE",
                            type: "analysis"
                        },
                        {
                            text: "Connect them with others who've healed similar wounds",
                            mechanics: "PRESENCE + HARMONY",
                            type: "community"
                        }
                    ]
                },
                wokemound: {
                    location: "The Pig Lady's BBQ Joint",
                    context: "Family restaurant with hidden resistance headquarters beneath",
                    content: "The smell of barbecue smoke mingles with tension as you enter Ursula Swine's establishment. She appears to be just another small-town cook, but you sense the sharp intelligence behind her meek facade. Several locals sit at tables, their eyes slightly too green - a sign of Green Goodness exposure. In the corner, a nervous young man fidgets with what looks like a modified radio device. The resistance meeting is tonight, and information about Dr. Poppers' location has finally surfaced.",
                    choices: [
                        {
                            text: "Approach Ursula discreetly and offer to help the resistance",
                            mechanics: "PRESENCE + RESOLVE",
                            type: "resistance"
                        },
                        {
                            text: "Investigate the nervous man with the radio device",
                            mechanics: "INSIGHT + PRESENCE",
                            type: "investigation"
                        },
                        {
                            text: "Order food and observe the green-eyed customers carefully",
                            mechanics: "INSIGHT + RESOLVE",
                            type: "observation"
                        },
                        {
                            text: "Look for the hidden entrance to the basement headquarters",
                            mechanics: "INSIGHT + VIGOR",
                            type: "exploration"
                        }
                    ]
                }
            };

            const currentStory = stories[gameState.currentReality];
            updateStoryDisplay({
                story: {
                    location: currentStory.location,
                    context: currentStory.context,
                    text: currentStory.content
                },
                choices: currentStory.choices
            });
        }

        // Update story display
        function updateStoryDisplay(data) {
            document.getElementById('locationName').textContent = data.story.location || "Unknown Location";
            document.getElementById('locationContext').textContent = data.story.context || "";
            document.getElementById('storyContent').textContent = data.story.text || "";
            document.getElementById('choiceCount').textContent = `${data.choices.length} choices available`;

            // Clear existing choices
            const choicesSection = document.querySelector('.choices-section');
            const existingChoices = choicesSection.querySelectorAll('.choice-option');
            existingChoices.forEach(choice => choice.remove());

            // Add new choices
            data.choices.forEach((choice, index) => {
                const choiceElement = document.createElement('div');
                choiceElement.className = 'choice-option';
                if (choice.type === 'community' || choice.type === 'service') {
                    choiceElement.classList.add('community-choice');
                }
                choiceElement.onclick = () => selectChoice(index + 1, choice);
                choiceElement.innerHTML = `
                    <div class="choice-text">${choice.text}</div>
                    <div class="choice-meta">
                        <span>${getChoiceIcon(choice.type)} ${choice.type || 'Action'}</span>
                        <span>${choice.mechanics || 'Unknown'}</span>
                    </div>
                `;
                
                choicesSection.appendChild(choiceElement);
            });
        }

        // Get choice type icon
        function getChoiceIcon(type) {
            const icons = {
                service: 'ü§ù',
                leadership: 'üëë',
                analysis: 'üîç',
                community: 'üèòÔ∏è',
                resistance: '‚ö°',
                investigation: 'üïµÔ∏è',
                observation: 'üëÅÔ∏è',
                exploration: 'üó∫Ô∏è',
                learning: 'üìö',
                challenge: '‚ö°'
            };
            return icons[type] || '‚ö°';
        }

        // Select a choice
        async function selectChoice(choiceIndex, choiceData) {
            if (gameState.isLoading) return;
            
            try {
                gameState.isLoading = true;
                showStoryLoading('Processing your choice...');
                
                // Animate choice selection
                document.querySelectorAll('.choice-option').forEach(option => {
                    option.style.opacity = '0.5';
                    option.style.pointerEvents = 'none';
                });

                // Process choice through API if available
                const response = await fetch(`${BACKEND_URL}/api/choice/process`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        passphrase: gameState.passphrase,
                        choice: choiceData
                    })
                });

                let result;
                if (response.ok) {
                    const data = await response.json();
                    result = data.result;
                } else {
                    result = processChoiceLocally(choiceData);
                }

                // Update player stats if they changed
                if (result.statsChanged) {
                    Object.keys(result.statsChanged).forEach(stat => {
                        const currentValue = gameState.player.stats[stat];
                        const change = result.statsChanged[stat];
                        const newValue = Math.min(100, Math.max(0, currentValue + change));
                        gameState.player.stats[stat] = newValue;
                        
                        // Animate stat change
                        animateStatChange(stat, newValue);
                    });
                }

                // Update spiral points
                if (result.spiralPoints) {
                    gameState.player.spiral_points += result.spiralPoints;
                    document.getElementById('spiralPoints').textContent = `${gameState.player.spiral_points} Spiral Points`;
                    
                    // Show spiral point gain
                    showSpiralPointGain(result.spiralPoints);
                }

                // Generate next story content
                setTimeout(async () => {
                    await generateNewStory();
                }, 2000);

            } catch (error) {
                console.error('Choice processing error:', error);
                generateBasicStory();
            }
        }

        // Process choice locally (fallback)
        function processChoiceLocally(choiceData) {
            const mechanics = choiceData.mechanics || '';
            const statsChanged = {};
            let spiralPoints = 0;

            // Basic stat increases based on mechanics
            if (mechanics.includes('INSIGHT')) {
                statsChanged.insight = Math.floor(Math.random() * 5) + 3;
            }
            if (mechanics.includes('PRESENCE')) {
                statsChanged.presence = Math.floor(Math.random() * 5) + 3;
            }
            if (mechanics.includes('RESOLVE')) {
                statsChanged.resolve = Math.floor(Math.random() * 5) + 3;
            }
            if (mechanics.includes('VIGOR')) {
                statsChanged.vigor = Math.floor(Math.random() * 5) + 3;
            }
            if (mechanics.includes('HARMONY')) {
                statsChanged.harmony = Math.floor(Math.random() * 5) + 3;
            }

            // Spiral points based on choice type
            if (choiceData.type === 'service') {
                spiralPoints = Math.floor(Math.random() * 20) + 15;
            } else if (choiceData.type === 'community') {
                spiralPoints = Math.floor(Math.random() * 15) + 10;
            } else {
                spiralPoints = Math.floor(Math.random() * 10) + 5;
            }

            return {
                statsChanged: statsChanged,
                spiralPoints: spiralPoints,
                outcome: "Choice processed successfully"
            };
        }

        // Animate stat change
        function animateStatChange(stat, newValue) {
            const valueElement = document.getElementById(`${stat}Value`);
            const barElement = document.getElementById(`${stat}Bar`);
            
            // Animate number
            const startValue = parseInt(valueElement.textContent);
            animateNumber(valueElement, startValue, newValue, 1000);
            
            // Animate bar
            setTimeout(() => {
                barElement.style.width = newValue + '%';
            }, 500);
            
            // Highlight effect
            valueElement.style.color = '#2ecc71';
            setTimeout(() => {
                valueElement.style.color = '#f0c674';
            }, 2000);
        }

        // Animate number change
        function animateNumber(element, start, end, duration) {
            const range = end - start;
            const startTime = performance.now();
            
            function updateNumber(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const current = Math.round(start + (range * progress));
                element.textContent = current;
                
                if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                }
            }
            
            requestAnimationFrame(updateNumber);
        }

        // Show spiral point gain
        function showSpiralPointGain(points) {
            const display = document.createElement('div');
            display.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(45deg, #f39c12, #e67e22);
                color: white;
                padding: 20px 30px;
                border-radius: 15px;
                font-size: 1.4em;
                font-weight: bold;
                z-index: 1000;
                box-shadow: 0 10px 30px rgba(243, 156, 18, 0.4);
                animation: fadeInOut 3s ease forwards;
            `;
            display.textContent = `+${points} Spiral Points!`;
            document.body.appendChild(display);
            
            setTimeout(() => {
                document.body.removeChild(display);
            }, 3000);
        }

        // Loading states
        function showStoryLoading(text = 'Loading...') {
            const overlay = document.getElementById('storyLoading');
            const textElement = overlay.querySelector('.loading-text');
            textElement.textContent = text;
            overlay.classList.add('show');
        }

        function hideStoryLoading() {
            document.getElementById('storyLoading').classList.remove('show');
        }

        // Action buttons
        function viewMemory(memoryId) {
            alert(`Memory ${memoryId}: This would show detailed memory information and consciousness insights.`);
        }

        function accessMemoryArchive() {
            alert('Memory Archive: This would open the full memory tracking system with consciousness pattern recognition.');
        }

        function dreamSharing() {
            if (gameState.player && gameState.player.consciousness_level >= 2) {
                alert('Dream Sharing: This would open the system for helping heal others\' nightmare realities.');
            } else {
                alert('Dream Sharing requires Consciousness Level 2 (Recognition) or higher. Continue your evolution!');
            }
        }

        function returnToLanding() {
            if (confirm('Return to the landing page? Your progress is automatically saved.')) {
                window.location.href = '/';
            }
        }

        // Add CSS animation for spiral point display
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeInOut {
                0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
                80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            }
        `;
        document.head.appendChild(style);

        // Initialize game when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeGame();
        });
    </script>
</body>
</html>